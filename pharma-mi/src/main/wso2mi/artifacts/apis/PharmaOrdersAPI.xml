<?xml version="1.0" encoding="UTF-8"?>
<api xmlns="http://ws.apache.org/ns/synapse"
     name="PharmaOrdersAPI"
     context="/orders/1.0.0"
     version="1.0.0"
     version-type="context"
     statistics="disable"
     trace="disable">

    <!-- Sync RX order creation
         POST /orders/1.0.0/prescriptions/sync -->
    <resource methods="POST" uri-template="/prescriptions/sync">
        <inSequence>
            <sequence key="CommonInSeq"/>

            <property name="messageType" value="application/json" scope="axis2"/>

            <log level="custom">
                <property name="log.type" value="RX_ORDER_SYNC_REQUEST"/>
                <property name="storeId" expression="json-eval($.storeId)"/>
                <property name="sku" expression="json-eval($.sku)"/>
                <property name="correlationId" expression="get-property('CorrelationId')"/>
            </log>

            <!-- Prevent /orders/1.0.0/prescriptions/sync from being appended -->
            <property name="REST_URL_POSTFIX"
                      scope="axis2"
                      action="remove"/>

            <call>
                <endpoint key="PrescriptionOrderEP"/>
            </call>

            <sequence key="CommonOutSeq"/>
            <respond/>
        </inSequence>

        <faultSequence>
            <sequence key="CommonFaultSeq"/>
        </faultSequence>
    </resource>

    <!-- Async RX order creation
         POST /orders/1.0.0/prescriptions/async -->
    <resource methods="POST" uri-template="/prescriptions/async">
        <inSequence>
            <sequence key="CommonInSeq"/>

            <property name="messageType" value="application/json" scope="axis2"/>

            <log level="custom">
                <property name="log.type" value="RX_ORDER_ASYNC_REQUEST"/>
                <property name="storeId" expression="json-eval($.storeId)"/>
                <property name="sku" expression="json-eval($.sku)"/>
                <property name="correlationId" expression="get-property('CorrelationId')"/>
            </log>

            <property name="REST_URL_POSTFIX"
                      scope="axis2"
                      action="remove"/>

            <property name="ASYNC_OPERATION" value="PRESCRIPTION_ORDER" scope="default"/>
            <property name="ASYNC_QUEUE" value="RxOrderStore" scope="default"/>
            <property name="ASYNC_PROCESSOR" value="RxOrderProcessor" scope="default"/>

            <property name="OUT_ONLY" value="true" scope="axis2" type="STRING"/>

            <store messageStore="RxOrderStore"/>

            <sequence key="AsyncAckSeq"/>
        </inSequence>

        <faultSequence>
            <sequence key="CommonFaultSeq"/>
        </faultSequence>
    </resource>

    <!-- GET /orders/1.0.0/{id} â€“ used by GetOrderStatusTool -->
    <resource methods="GET" uri-template="/*">
        <inSequence>
            <sequence key="CommonInSeq"/>

            <!-- Rebuild backend URI: /orders/{id} -->
            <property name="REST_URL_POSTFIX"
                      expression="concat('/orders', get-property('axis2','REST_URL_POSTFIX'))"
                      scope="axis2"
                      type="STRING"/>

            <send>
                <endpoint key="OrdersStatusEP"/>
            </send>
        </inSequence>

        <outSequence>
            <sequence key="CommonOutSeq"/>
            <send/>
        </outSequence>

        <faultSequence>
            <sequence key="CommonFaultSeq"/>
        </faultSequence>
    </resource>
</api>
